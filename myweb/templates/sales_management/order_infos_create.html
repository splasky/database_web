{% extends 'base.html' %}
{% block javascript %}
<!-- <script type="text/javascript"> -->
var intId=1;
    {% comment %}
function add_new_data() {
    var num = document.getElementById("order_details_table").rows.length;
    intId=num;
    var Tr = document.getElementById("order_details_table").insertRow(num);
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<select name="key[]"> {% for i in product_list %} <option value="{{i.id}}">{{i.name}}</option> {% endfor %} </select> ';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="price[]" type="text" size="12" class="product_price" id="price'+intId+'" onchange="c('+intId+')" value="0">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="amount[]" type="text" size="12" class="product_amount" id="amount'+intId+'" onchange="c('+intId+')" value="0">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="subtotal[]" type="text" size="12" class="product_subtotal" id="subtotal'+intId+'" onchange="total_price()" value="0">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="remark[]" type="text" size="12">';
}
    {% endcomment %}

$(document).ready(function(){
    $('.menu-item-add').click(function (e) {
        <!-- e.preventDefault(); -->

        var lastElement = $('.menu-item:last');
        var totalForms = $('#id_form-TOTAL_FORMS');
        var total = parseInt(totalForms.val());

        var newElement = lastElement.clone(true);
        newElement.find(':input').each(function() {
        var name = $(this).attr('name').replace(
          '-' + (total - 1) + '-',
          '-' + total + '-'
        );
        var id = 'id_' + name;
        $(this).attr({'name': name, 'id': id});
        });

		/* replace previous id */
        newElement.find('label').each(function() {
        $(this).attr('for', $(this).attr('for').replace(
          '-' + (total - 1) + '-',
          '-' + total + '-'
            ));
        });

        totalForms.val(total + 1);
        newElement.insertAfter(lastElement);
    });
});

function c(Id){
        // var price=$(this).next().val();
        // var price=$(this).siblings('#price').val();
        // var num =$(this).siblings('#num').val();
        // var num=$(this).prev();
        var price =$('tr').find('#price'+Id).val();
        var num = $('tr').find('#amount'+Id).val();
        var amount =price*num;

        // $('tr.fieldwrapper').find('.amount').val(amount);
        $('tr').find('#subtotal'+Id).val(amount);
        total_price();
}

function total_price(){
    var total_price=0
    for (i=1;i<=intId;i++){
    var price=$('#subtotal'+i).val();
    total_price=parseInt(total_price)+parseInt(price);
    }
    $('#id_total').val(total_price);
}

function remove_data() {
    var lastElement = $('.menu-item:last');
    var totalForms = $('#id_form-TOTAL_FORMS');
    var total = parseInt(totalForms.val());

    if(total > 1)
    {
    /* remove last div */
    lastElement.remove();
    }
    total_price();
    totalForms.val(total - 1);
}

$.ajaxSetup({
    data:{
        csrfmiddlewaretoken:'{{ csrf_token }}'
    },
});

{% endblock %}
{% block title %}{{ table_name }}{% endblock %}
{% block content %}

<form action="" method="post">
    {% csrf_token %}
    <table>
        <tr>
        <th><label>Client</label></th>
        <td>{{ form.client }}</td>
        </tr>
        <tr>
        <th><label>預計出貨日期</label></th>
        <td>{{ form.estimated_shipping_date }}</td>
        </tr>
        <tr>
        <th><label>送貨地址</label></th>
        <td>{{ form.delivery_address }}</td>
        </tr>
        <tr>
        <th><label>統一編號</label></th>
        <td>{{ form.invoice_number }}</td>
        </tr>
    </table>
    {% comment %}
    <table id="order_details_table">
        <tr>
            <th>商品名稱</th>
            <th>售價</th>
            <th>數量</th>
            <th>小計</th>
            <th>備註</th>
        </tr>
        <tr >
        <div class="menu-item form-group">
            <td>
                {{ form.details_form.product }}
            </td>
            <td>
                {{ form.details_form.price }}
            </td>
            <td>
                {{ form.details_form.quantity }}
            </td>
            <td>
                {{ form.details_form.subtotal }}
            </td>
            <td>
                {{ form.details_form.remark }}
            </td>
        </div>
        </tr>
    </table>
    {% endcomment %}
	{{ menu_item_formset.management_form }}
    {% for form in menu_item_formset %}
    <div class="menu-item form-group">
		{{ form.as_table }}
    </div>
	{% endfor %}
    <input value="新增項目" type="button" class="menu-item-add">
    <input value="減少項目" onclick="remove_data()" type="button">
    <br>
    <label>合計</label> {{ form.total }}
    <br>
    <input type="submit" value="Submit" id="ajax_post_test"/>
    </tr>
</form>

{% endblock %}
