{% extends 'base.html' %}
{% block javascript %}
<!-- <script type="text/javascript"> -->
var intId=0;
function add_new_data() {
    var num = document.getElementById("order_details_table").rows.length;
    intId=num;
    var Tr = document.getElementById("order_details_table").insertRow(num);
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<select name="key[]"> {% for i in product_list %} <option value="{{i.id}}">{{i.name}}</option> {% endfor %} </select> ';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="price[]" type="text" size="12" class="product_price" id="price'+intId+'" onchange="c('+intId+')">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="amount[]" type="text" size="12" class="product_amount" id="amount'+intId+'" onchange="c('+intId+')">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="subtotal[]" type="text" size="12" class="product_subtotal" id="subtotal'+intId+'" onchange="total_price()">';
    Td = Tr.insertCell(Tr.cells.length);
    Td.innerHTML='<input name="remark[]" type="text" size="12">';
}

    function c(Id){
            // var price=$(this).next().val();
            // var price=$(this).siblings('#price').val();
            // var num =$(this).siblings('#num').val();
            // var num=$(this).prev();
            var price =$('tr').find('#price'+Id).val();
            var num = $('tr').find('#amount'+Id).val();
            var amount =price*num;
            
            // $('tr.fieldwrapper').find('.amount').val(amount);
            $('tr').find('#subtotal'+Id).val(amount);
            total_price();
        }
    function total_price(){
        var total_price=0
        for (i=1;i<=intId;i++){
        
        var price=$('#subtotal'+i).val();
        total_price=parseInt(total_price)+parseInt(price);
        }

        
        $('#total_price').val(total_price);
    }



function remove_data() {

    var num = document.getElementById("order_details_table").rows.length;
    if(num > 2)
    {
    // remove the last row
     document.getElementById("order_details_table").deleteRow(-1);
    }
    total_price();
}

$.ajaxSetup({
    data:{
        csrfmiddlewaretoken:'{{ csrf_token }}'
    },
});

$(document).ready(function(){
    $("#ajax_post_test").submit(function(){

        var table_product_name = [];
        var table_price=[]
        var table_amount=[]
        var table_subtotal=[]
        var table_remark=[]

        var len = document.getElementById("order_details_table").rows.length;
        console.log(len)
        var table = document.getElementById("order_details_table");

        for(var i =0;i<len-1;i++){
            table_product_name.push(table.querySelectorAll('[name="product_name[]"]')[i].value)
            table_price.push(table.querySelectorAll('[name="price[]"]')[i].value)
            table_amount.push(table.querySelectorAll('[name="amount[]"]')[i].value)
            table_subtotal.push(table.querySelectorAll('[name="subtotal[]"]')[i].value)
            table_remark.push(table.querySelectorAll('[name="remark[]"]')[i].value)
        }

        console.log(table_product_name);
        console.log(table_price);
        console.log(table_amount);
        console.log(table_subtotal);
        console.log(table_remark);

        $.ajax({
                url:"{% url 'create_order-ajax' %}",
                data:{
                    "product_name":table_product_name,
                    "price":table_price,
                    "amount":table_amount,
                    "subtotal":table_subtotal,
                    "remark":table_remark
                },
                success:function(data){
                    window.location.replace("{% url 'order_info-list' %}")
                },
                type:"POST",
                dataType: "json"
        });
    });
});

{% endblock %}
{% block title %}{{ table_name }}{% endblock %}
{% block content %}
{% comment %}
update delete
{% endcomment %}

<form action="" method="post">
    {% csrf_token %}
    <table>
        {{ form.as_table }}
    </table>
    <table id="order_details_table">
        <tr>
            <th>商品名稱</th>
            <th>售價</th>
            <th>數量</th>
            <th>小計</th>
            <th>備註</th>
        </tr>
        <tr >
            
            <td>
                <select name="key[]">
                {% for i in product_list %}
                <option value="{{i.id}}">{{i.name}}</option>
                {% endfor %}
                </select> 
            </td>
            <td>
                <input type="text" name="price[]" class="product_price" id="price1" onchange="c(1)" size=12>
            </td>
            <td>
                <input type="text" name="amount[]" class="product_amount" id="amount1" onchange="c(1)" size=12>
            </td>
            <td>
                <input type="text" name="subtotal[]" class="product_subtotal" id="subtotal1" onchange="total_price()" value="0"  size=12>
            </td>
            <td>
                <input type="text" name="remark[]" size=12>
            </td>
           
        </tr>
    </table>
    <input value="increase" onclick="add_new_data()" type="button">
    <input value="decrease" onclick="remove_data()" type="button">
    <input type="submit" value="Submit" id="ajax_post_test"/>
</form>
<h3>總金額</h3>
<input type="text" id="total_price"  name="">
{% endblock %}